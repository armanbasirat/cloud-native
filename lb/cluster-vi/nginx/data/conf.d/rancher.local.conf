upstream rancher-backend {
         ip_hash;
         server wrkr1:443;
         server wrkr2:443;
         server wrkr3:443;
         server wrkr4:443;
}

server {

        listen 443 ssl;
        error_page   403  /403.html;
        server_name rancher.local;
        ssl_certificate /certs/rancher.local.crt;
        ssl_certificate_key /certs/rancher.local.key;
        ssl_protocols TLSv1.2;
        access_log /var/log/nginx/rancher.log main;

        if ($host != "rancher.local") {
         return 404;
        }


        location = /403.html {
                 root   /var/www/html;
        }

        location / {
                 #include conf.d/virtual_allowed_ips;
                 proxy_set_header Host            $host;
                 proxy_set_header X-Forwarded-For $remote_addr;
                 proxy_set_header X-Forwarded-Proto $scheme;
                 proxy_read_timeout 90;
                 proxy_set_header Upgrade $http_upgrade;
                 proxy_set_header Connection "Upgrade";
                 proxy_http_version 1.1;
                 proxy_pass https://rancher-backend;
        }
}


server {

        listen 80;
        server_name rancher.local;
        return 301 https://$host$request_uri;
}